<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text x='.07em' y='.82em' font-size='100'>📝</text></svg>"><title>PayPal WebHook 事件异步通知</title><link rel="stylesheet" href="https://storage.roamnote.com:8000/index.css"><script src="https://storage.roamnote.com:8000/fuse.js"></script>
<script src="https://storage.roamnote.com:8000/index.js"></script>
<script>window.onload=async()=>{moveBreadcrumb(),closeTocWhenScroll(),updateHeaderBgColor(),initialSearch("https://storage.roamnote.com:8000/index.json")}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-QC2GM314WK"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QC2GM314WK")</script></head><body><header><nav id="Breadcrumb"><a href="/" title="漫游笔记" data-short-title="🏠"><span>🏠 漫游笔记</span></a>
<a href="/play-with-code/" title="Play With Code" data-short-title="Play"><span title="Play With Code">Play With Code</span></a>
<a href="/play-with-code/paypal-webhook-%E4%BA%8B%E4%BB%B6%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5/" title="PayPal WebHook 事件异步通知" data-short-title="PayP"><span id="LastBreadcrumb" title="PayPal WebHook 事件异步通知">PayPal WebHook 事件异步通知</span></a></nav><div id="Toolbar" data-nosnippet=""><details id="TocButton"><summary><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path></svg></summary><nav id="TableOfContents"><ul><li><a href="#paypal-webhook">PayPal WebHook</a><ul><li><a href="#配置webhook地址和订阅事件">配置WebHook地址和订阅事件</a></li><li><a href="#webhook事件">Webhook事件</a></li></ul></li><li><a href="#接收并验证webhook消息">接收并验证Webhook消息</a><ul><li><a href="#验证方式一调接口获取webhook详情">验证方式一：调接口获取webhook详情</a></li><li><a href="#验证方式二调用验签api">验证方式二：调用验签API</a></li><li><a href="#验证方式三自己手动验证">验证方式三：自己手动验证</a></li><li><a href="#其他说明">其他说明</a></li></ul></li></ul></nav><div id="TocHeaderMask"></div></details><button id="SearchButton">🔍</button></div></header><div id="SearchBox" data-nosnippet=""><input id="SearchInput" tabindex="0" autocomplete="off" placeholder="搜索"><div id="SearchToolBar"></div><div id="SearchResults" class="no-hover"></div></div><main><article pageurl="/play-with-code/paypal-webhook-%E4%BA%8B%E4%BB%B6%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5/" pagetitle="PayPal WebHook 事件异步通知"><h1 id="a0">PayPal WebHook 事件异步通知</h1><time id="UpdateDate">2024年01月26日</time><aside id="TocArticle"><nav id="TableOfContents"><ul id="a4"><li id="a5"><a href="#paypal-webhook" id="a6">PayPal WebHook</a><ul id="a7"><li id="a8"><a href="#配置webhook地址和订阅事件" id="a9">配置WebHook地址和订阅事件</a></li><li id="a10"><a href="#webhook事件" id="a11">Webhook事件</a></li></ul></li><li id="a12"><a href="#接收并验证webhook消息" id="a13">接收并验证Webhook消息</a><ul id="a14"><li id="a15"><a href="#验证方式一调接口获取webhook详情" id="a16">验证方式一：调接口获取webhook详情</a></li><li id="a17"><a href="#验证方式二调用验签api" id="a18">验证方式二：调用验签API</a></li><li id="a19"><a href="#验证方式三自己手动验证" id="a20">验证方式三：自己手动验证</a></li><li id="a21"><a href="#其他说明" id="a22">其他说明</a></li></ul></li></ul></nav></aside><a id="fixYOffset" class="internal-link" href="#" style=""></a><p id="a24"><span class="unwrap" id="a25">另一个文章 <a href="https://www.bahjeez.com/validating-paypal-webhooks-offline-almost/" class="external-link" target="_blank" id="a26">https://www.bahjeez.com/validating-paypal-webhooks-offline-almost/</a> ，阐述了如何实现</span></p><h2 class="heading" id="paypal-webhook">PayPal WebHook<a class="heading-anchor" href="/play-with-code/paypal-webhook-%E4%BA%8B%E4%BB%B6%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5/#paypal-webhook" id="a28"></a></h2><p id="a29"><span class="unwrap" id="a30">即 paypal 异步通知功能，订阅了相应的事件后，当发生了订阅的事件，paypal 会 post 一个 json 格式的数据到所配置的地址上。</span></p><h3 class="heading" id="配置webhook地址和订阅事件">配置WebHook地址和订阅事件<a class="heading-anchor" href="/play-with-code/paypal-webhook-%E4%BA%8B%E4%BB%B6%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5/#%e9%85%8d%e7%bd%aewebhook%e5%9c%b0%e5%9d%80%e5%92%8c%e8%ae%a2%e9%98%85%e4%ba%8b%e4%bb%b6" id="a32"></a></h3><p id="a33"><span class="unwrap" id="a34"><a href="https://developer.paypal.com/developer/applications" class="external-link" target="_blank" id="a35">https://developer.paypal.com/developer/applications</a></span></p><p id="a36"><span class="unwrap" id="a37">选择查看应用详情后拉到最下面的Webhook配置，输入通知地址和订阅事件，点击保存后，会生成一个Webhook&nbsp;ID（在验证Webhook信息的时候用到）。</span></p><p id="a38"><span class="unwrap" id="a39">checkout&nbsp;order相关的事件：<a href="https://developer.paypal.com/docs/checkout/apm/reference/subscribe-to-webhooks/" class="external-link" target="_blank" id="a40">https://developer.paypal.com/docs/checkout/apm/reference/subscribe-to-webhooks/</a></span></p><p id="a41"><span class="unwrap" id="a42">所有事件：<a href="https://developer.paypal.com/api/rest/webhooks/event-names/" class="external-link" target="_blank" id="a43">https://developer.paypal.com/api/rest/webhooks/event-names/</a></span></p><p id="a44"><span class="unwrap" id="a45">需要响应200状态码表示处理成功，否则会在3天内最多发送10次。</span></p><h3 class="heading" id="webhook事件">Webhook事件<a class="heading-anchor" href="/play-with-code/paypal-webhook-%E4%BA%8B%E4%BB%B6%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5/#webhook%e4%ba%8b%e4%bb%b6" id="a47"></a></h3><ul id="a48"><li id="a49">CHECKOUT.ORDER.APPROVED：客户授权支付，此时可收款。</li><li id="a50">PAYMENT.CAPTURE.COMPLETED：收款完成，即交易完成。</li><li id="a51">PAYMENT.CAPTURE.PENDING：交易需要审核。</li><li id="a52">PAYMENT.CAPTURE.DENIED：拒绝了收款。</li><li id="a53">PAYMENT.CAPTURE.REFUNDED：退款。</li><li id="a54">CUSTOMER.DISPUTE.CREATED：客户发起争议，此时也会收到RISK.DISPUTE.CREATED消息，内容一致。</li><li id="a55">CUSTOMER.DISPUTE.RESOLVED：争议解决。</li></ul><h2 class="heading" id="接收并验证webhook消息">接收并验证Webhook消息<a class="heading-anchor" href="/play-with-code/paypal-webhook-%E4%BA%8B%E4%BB%B6%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5/#%e6%8e%a5%e6%94%b6%e5%b9%b6%e9%aa%8c%e8%af%81webhook%e6%b6%88%e6%81%af" id="a57"></a></h2><p id="a58"><span class="unwrap" id="a59">为了保证webhook消息的真实性，需要对消息进行验证，避免处理假消息。参考文档地址：<a href="https://developer.paypal.com/api/rest/webhooks/" class="external-link" target="_blank" id="a60">https://developer.paypal.com/api/rest/webhooks/</a></span></p><p id="a61"><span class="unwrap" id="a62">需要用到的header:</span></p><ul id="a63"><li id="a64">PAYPAL-TRANSMISSION-ID: Http 传输的唯一ID</li><li id="a65">PAYPAL-TRANSMISSION-TIME：时间</li><li id="a66">PAYPAL-CERT-URL：Public&nbsp;key 地址</li><li id="a67">PAYPAL-TRANSMISSION-SIG：签名</li><li id="a68">PAYPAL-AUTH-ALGO：签名算法</li></ul><h3 class="heading" id="验证方式一调接口获取webhook详情">验证方式一：调接口获取webhook详情<a class="heading-anchor" href="/play-with-code/paypal-webhook-%E4%BA%8B%E4%BB%B6%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5/#%e9%aa%8c%e8%af%81%e6%96%b9%e5%bc%8f%e4%b8%80%e8%b0%83%e6%8e%a5%e5%8f%a3%e8%8e%b7%e5%8f%96webhook%e8%af%a6%e6%83%85" id="a70"></a></h3><p id="a71"><span class="unwrap" id="a72">通过Webhook的消息ID调用接口去获取webhook消息详情</span></p><p id="a73"><span class="unwrap" id="a74">GET&nbsp;<a href="https://api.paypal.com/v1/notifications/webhooks-events/" class="external-link" target="_blank" id="a75">https://api.paypal.com/v1/notifications/webhooks-events/</a>{EVENT_ID}</span></p><h3 class="heading" id="验证方式二调用验签api">验证方式二：调用验签API<a class="heading-anchor" href="/play-with-code/paypal-webhook-%E4%BA%8B%E4%BB%B6%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5/#%e9%aa%8c%e8%af%81%e6%96%b9%e5%bc%8f%e4%ba%8c%e8%b0%83%e7%94%a8%e9%aa%8c%e7%ad%beapi" id="a77"></a></h3><p id="a78"><span class="unwrap" id="a79">调用paypal的验签API</span></p><p id="a80"><span class="unwrap" id="a81">POST&nbsp;<a href="https://api.paypal.com/v1/notifications/verify-webhook-signature" class="external-link" target="_blank" id="a82">https://api.paypal.com/v1/notifications/verify-webhook-signature</a></span></p><h4 class="heading" id="参数">参数<a class="heading-anchor" href="/play-with-code/paypal-webhook-%E4%BA%8B%E4%BB%B6%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5/#%e5%8f%82%e6%95%b0" id="a84"></a></h4><div class="highlight" id="a85"><pre tabindex="0" class="torchlight" style="overflow: hidden;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f" onmouseenter="setTimeout(function() { this.style.overflow = 'auto'; }.bind(this), 300)" onmouseleave="this.style.overflow = 'hidden';" ontouchstart="setTimeout(function() { this.style.overflow = 'auto'; }.bind(this), 300)" id="a86"><button data-text="复制" onclick="window.navigator.clipboard.writeText(nextElementSibling.innerText.replace(/&nbsp;/g, ''));this.setAttribute('data-text', '已复制');style='background-color: #009900';setTimeout(() => {this.setAttribute('data-text', '复制');this.removeAttribute('style')}, 1000);" id="a87"></button><code id="a88"><!-- Syntax highlighted by torchlight.dev --><div class="line" id="a89"><span style="color: #F8F8F2;" id="a90">{</span></div><div class="line" id="a91"><span style="color: #F8F8F2;" id="a92">    /**</span></div><div class="line" id="a93"><span style="color: #F8F8F2;" id="a94">     * 签名方式，可从header信息的PAYPAL-AUTH-ALGO获取</span></div><div class="line" id="a95"><span style="color: #F8F8F2;" id="a96">     */</span></div><div class="line" id="a97"><span style="color: #F8F8F2;" id="a98">    "auth_algo": string;</span></div><div class="line" id="a99"><span style="color: #F8F8F2;" id="a100">    /**</span></div><div class="line" id="a101"><span style="color: #F8F8F2;" id="a102">     * 公钥地址，可从header信息的PAYPAL-CERT-URL获取</span></div><div class="line" id="a103"><span style="color: #F8F8F2;" id="a104">     */</span></div><div class="line" id="a105"><span style="color: #F8F8F2;" id="a106">    "cert_url": string;</span></div><div class="line" id="a107"><span style="color: #F8F8F2;" id="a108">    /**</span></div><div class="line" id="a109"><span style="color: #F8F8F2;" id="a110">     * HTTP传输ID，可从header信息的PAYPAL-TRANSMISSION-ID获取</span></div><div class="line" id="a111"><span style="color: #F8F8F2;" id="a112">     */</span></div><div class="line" id="a113"><span style="color: #F8F8F2;" id="a114">    "transmission_id": string;</span></div><div class="line" id="a115"><span style="color: #F8F8F2;" id="a116">    /**</span></div><div class="line" id="a117"><span style="color: #F8F8F2;" id="a118">     * 签名，可从header信息的PAYPAL-TRANSMISSION-SIG获取</span></div><div class="line" id="a119"><span style="color: #F8F8F2;" id="a120">     */</span></div><div class="line" id="a121"><span style="color: #F8F8F2;" id="a122">    "transmission_sig": string;</span></div><div class="line" id="a123"><span style="color: #F8F8F2;" id="a124">    /**</span></div><div class="line" id="a125"><span style="color: #F8F8F2;" id="a126">     * 时间，可从header信息的PAYPAL-TRANSMISSION-TIME获取</span></div><div class="line" id="a127"><span style="color: #F8F8F2;" id="a128">     */</span></div><div class="line" id="a129"><span style="color: #F8F8F2;" id="a130">    "transmission_time": string;</span></div><div class="line" id="a131"><span style="color: #F8F8F2;" id="a132">    /**</span></div><div class="line" id="a133"><span style="color: #F8F8F2;" id="a134">     * Webhook ID，即webhook配置的ID</span></div><div class="line" id="a135"><span style="color: #F8F8F2;" id="a136">     */</span></div><div class="line" id="a137"><span style="color: #F8F8F2;" id="a138">    "webhook_id": string;</span></div><div class="line" id="a139"><span style="color: #F8F8F2;" id="a140">    /**</span></div><div class="line" id="a141"><span style="color: #F8F8F2;" id="a142">     * webhook事件</span></div><div class="line" id="a143"><span style="color: #F8F8F2;" id="a144">     */</span></div><div class="line" id="a145"><span style="color: #F8F8F2;" id="a146">    "webhook_event": string;</span></div><div class="line" id="a147"><span style="color: #F8F8F2;" id="a148">}</span></div></code></pre></div><h4 class="heading" id="响应">响应<a class="heading-anchor" href="/play-with-code/paypal-webhook-%E4%BA%8B%E4%BB%B6%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5/#%e5%93%8d%e5%ba%94" id="a150"></a></h4><div class="highlight" id="a151"><pre tabindex="0" class="torchlight" style="overflow: hidden;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f" onmouseenter="setTimeout(function() { this.style.overflow = 'auto'; }.bind(this), 300)" onmouseleave="this.style.overflow = 'hidden';" ontouchstart="setTimeout(function() { this.style.overflow = 'auto'; }.bind(this), 300)" id="a152"><button data-text="复制" onclick="window.navigator.clipboard.writeText(nextElementSibling.innerText.replace(/&nbsp;/g, ''));this.setAttribute('data-text', '已复制');style='background-color: #009900';setTimeout(() => {this.setAttribute('data-text', '复制');this.removeAttribute('style')}, 1000);" id="a153"></button><code id="a154"><!-- Syntax highlighted by torchlight.dev --><div class="line" id="a155"><span style="color: #F8F8F2;" id="a156">{</span></div><div class="line" id="a157"><span style="color: #F8F8F2;" id="a158">    /**</span></div><div class="line" id="a159"><span style="color: #F8F8F2;" id="a160">     * 验证结果</span></div><div class="line" id="a161"><span style="color: #F8F8F2;" id="a162">     * SUCCESS - 成功</span></div><div class="line" id="a163"><span style="color: #F8F8F2;" id="a164">     * FAILURE - 失败</span></div><div class="line" id="a165"><span style="color: #F8F8F2;" id="a166">     */</span></div><div class="line" id="a167"><span style="color: #F8F8F2;" id="a168">    "verification_status": string;</span></div><div class="line" id="a169"><span style="color: #F8F8F2;" id="a170">}</span></div></code></pre></div><h3 class="heading" id="验证方式三自己手动验证">验证方式三：自己手动验证<a class="heading-anchor" href="/play-with-code/paypal-webhook-%E4%BA%8B%E4%BB%B6%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5/#%e9%aa%8c%e8%af%81%e6%96%b9%e5%bc%8f%e4%b8%89%e8%87%aa%e5%b7%b1%e6%89%8b%e5%8a%a8%e9%aa%8c%e8%af%81" id="a172"></a></h3><p id="a173"><span class="unwrap" id="a174">验证签名，输入的字符串为：</span></p><div class="highlight" id="a175"><pre tabindex="0" class="torchlight" style="overflow: hidden;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f" onmouseenter="setTimeout(function() { this.style.overflow = 'auto'; }.bind(this), 300)" onmouseleave="this.style.overflow = 'hidden';" ontouchstart="setTimeout(function() { this.style.overflow = 'auto'; }.bind(this), 300)" id="a176"><button data-text="复制" onclick="window.navigator.clipboard.writeText(nextElementSibling.innerText.replace(/&nbsp;/g, ''));this.setAttribute('data-text', '已复制');style='background-color: #009900';setTimeout(() => {this.setAttribute('data-text', '复制');this.removeAttribute('style')}, 1000);" id="a177"></button><code id="a178"><!-- Syntax highlighted by torchlight.dev --><div class="line" id="a179">&nbsp;</div><div class="line" id="a180"><span style="color: #F8F8F2;" id="a181">&lt;transmissionId&gt;|&lt;timeStamp&gt;|&lt;webhookId&gt;|&lt;crc32&gt;</span></div><div class="line" id="a182">&nbsp;</div><div class="line" id="a183"><span style="color: #F8F8F2;" id="a184">FieldDescription</span></div><div class="line" id="a185">&nbsp;</div><div class="line" id="a186"><span style="color: #F8F8F2;" id="a187">|transmissionId|The unique ID of the HTTP transmission from the&nbsp;PAYPAL-TRANSMISSION-ID header.|</span></div><div class="line" id="a188"><span style="color: #F8F8F2;" id="a189">|timeStamp|The date and time when the HTTP message was transmitted from the&nbsp;PAYPAL-TRANSMISSION-TIME header.|</span></div><div class="line" id="a190"><span style="color: #F8F8F2;" id="a191">|webhookId|The ID of the webhook&nbsp;resource&nbsp;for the destination&nbsp;URL&nbsp;to which&nbsp;PayPal&nbsp;delivers the event notification.|</span></div><div class="line" id="a192"><span style="color: #F8F8F2;" id="a193">|crc32|The&nbsp;[Cyclic Redundancy Check&nbsp;(CRC32)](https://en.wikipedia.org/wiki/Cyclic_redundancy_check)&nbsp;checksum&nbsp;for the body of the HTTP&nbsp;payload.|</span></div><div class="line" id="a194">&nbsp;</div><div class="line" id="a195"><span style="color: #F8F8F2;" id="a196">使用crc32算法对post的数据进行多项式计算。</span></div></code></pre></div><div class="highlight" id="a197"><pre tabindex="0" style="overflow: hidden;" class="torchlight" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f" onmouseenter="setTimeout(function() { this.style.overflow = 'auto'; }.bind(this), 300)" onmouseleave="this.style.overflow = 'hidden';" ontouchstart="setTimeout(function() { this.style.overflow = 'auto'; }.bind(this), 300)" id="a198"><button data-text="复制" onclick="window.navigator.clipboard.writeText(nextElementSibling.innerText.replace(/&nbsp;/g, ''));this.setAttribute('data-text', '已复制');style='background-color: #009900';setTimeout(() => {this.setAttribute('data-text', '复制');this.removeAttribute('style')}, 1000);" id="a199"></button><code class="language-php" data-lang="php" id="a200"><!-- Syntax highlighted by torchlight.dev --><div class="line" id="a201"><span style="color: #F92672;" id="a202">&lt;?php</span></div><div class="line" id="a203"><span style="color: #F8F8F2;" id="a204">$dataUrlString </span><span style="color: #F92672;" id="a205">=</span><span style="color: #F8F8F2;" id="a206"> </span><span style="color: #66D9EF;" id="a207">file_get_contents</span><span style="color: #F8F8F2;" id="a208">(</span><span style="color: #E6DB74;" id="a209">'php://input'</span><span style="color: #F8F8F2;" id="a210">);</span></div><div class="line" id="a211"><span style="color: #F8F8F2;" id="a212">$headers </span><span style="color: #F92672;" id="a213">=</span><span style="color: #F8F8F2;" id="a214"> </span><span style="color: #66D9EF;" id="a215">self</span><span style="color: #F92672;" id="a216">::</span><span style="color: #A6E22E;" id="a217">getAllHeaders</span><span style="color: #F8F8F2;" id="a218">();</span><span style="color: #88846F;" id="a219">// 获取所有header</span></div><div class="line" id="a220"><span style="color: #F8F8F2;" id="a221">$paypalTransmissionId </span><span style="color: #F92672;" id="a222">=</span><span style="color: #F8F8F2;" id="a223"> $headers[</span><span style="color: #E6DB74;" id="a224">'PAYPAL-TRANSMISSION-ID'</span><span style="color: #F8F8F2;" id="a225">] </span><span style="color: #F92672;" id="a226">??</span><span style="color: #F8F8F2;" id="a227"> </span><span style="color: #E6DB74;" id="a228">''</span><span style="color: #F8F8F2;" id="a229">;</span></div><div class="line" id="a230"><span style="color: #F8F8F2;" id="a231">$timeStamp </span><span style="color: #F92672;" id="a232">=</span><span style="color: #F8F8F2;" id="a233"> $headers[</span><span style="color: #E6DB74;" id="a234">'PAYPAL-TRANSMISSION-TIME'</span><span style="color: #F8F8F2;" id="a235">] </span><span style="color: #F92672;" id="a236">??</span><span style="color: #F8F8F2;" id="a237"> </span><span style="color: #E6DB74;" id="a238">''</span><span style="color: #F8F8F2;" id="a239">;</span></div><div class="line" id="a240"><span style="color: #F8F8F2;" id="a241">$webhookId </span><span style="color: #F92672;" id="a242">=</span><span style="color: #F8F8F2;" id="a243"> </span><span style="color: #E6DB74;" id="a244">'WEBHOOK ID'</span><span style="color: #F8F8F2;" id="a245">;</span></div><div class="line" id="a246"><span style="color: #F8F8F2;" id="a247">$crc32 </span><span style="color: #F92672;" id="a248">=</span><span style="color: #F8F8F2;" id="a249"> </span><span style="color: #66D9EF;" id="a250">crc32</span><span style="color: #F8F8F2;" id="a251">($dataUrlString);</span></div><div class="line" id="a252">&nbsp;</div><div class="line" id="a253"><span style="color: #F92672;" id="a254">if</span><span style="color: #F8F8F2;" id="a255"> (</span><span style="color: #F92672;" id="a256">!</span><span style="color: #F8F8F2;" id="a257">$paypalTransmissionId </span><span style="color: #F92672;" id="a258">||</span><span style="color: #F8F8F2;" id="a259"> </span><span style="color: #F92672;" id="a260">!</span><span style="color: #F8F8F2;" id="a261">$timeStamp </span><span style="color: #F92672;" id="a262">||</span><span style="color: #F8F8F2;" id="a263"> </span><span style="color: #F92672;" id="a264">!</span><span style="color: #F8F8F2;" id="a265">$webhookId </span><span style="color: #F92672;" id="a266">||</span><span style="color: #F8F8F2;" id="a267"> </span><span style="color: #F92672;" id="a268">!</span><span style="color: #F8F8F2;" id="a269">$crc32) {</span></div><div class="line" id="a270"><span style="color: #F8F8F2;" id="a271">    </span><span style="color: #F92672;" id="a272">return</span><span style="color: #F8F8F2;" id="a273"> </span><span style="color: #AE81FF;" id="a274">false</span><span style="color: #F8F8F2;" id="a275">;</span></div><div class="line" id="a276"><span style="color: #F8F8F2;" id="a277">}</span></div><div class="line" id="a278">&nbsp;</div><div class="line" id="a279"><span style="color: #F8F8F2;" id="a280">$sigString </span><span style="color: #F92672;" id="a281">=</span><span style="color: #F8F8F2;" id="a282"> </span><span style="color: #E6DB74;" id="a283">"{</span><span style="color: #F8F8F2;" id="a284">$paypalTransmissionId</span><span style="color: #E6DB74;" id="a285">}|{</span><span style="color: #F8F8F2;" id="a286">$timeStamp</span><span style="color: #E6DB74;" id="a287">}|{</span><span style="color: #F8F8F2;" id="a288">$webhookId</span><span style="color: #E6DB74;" id="a289">}|{</span><span style="color: #F8F8F2;" id="a290">$crc32</span><span style="color: #E6DB74;" id="a291">}"</span><span style="color: #F8F8F2;" id="a292">;</span></div><div class="line" id="a293">&nbsp;</div><div class="line" id="a294"><span style="color: #88846F;" id="a295">// 通过PAYPAL-CERT-URL头信息去拿公钥</span></div><div class="line" id="a296"><span style="color: #F8F8F2;" id="a297">$publicKey </span><span style="color: #F92672;" id="a298">=</span><span style="color: #F8F8F2;" id="a299"> </span><span style="color: #66D9EF;" id="a300">openssl_pkey_get_public</span><span style="color: #F8F8F2;" id="a301">(</span><span style="color: #66D9EF;" id="a302">self</span><span style="color: #F92672;" id="a303">::</span><span style="color: #A6E22E;" id="a304">httpCurl</span><span style="color: #F8F8F2;" id="a305">($headers[</span><span style="color: #E6DB74;" id="a306">'PAYPAL-CERT-URL'</span><span style="color: #F8F8F2;" id="a307">]));</span></div><div class="line" id="a308"><span style="color: #F8F8F2;" id="a309">$details </span><span style="color: #F92672;" id="a310">=</span><span style="color: #F8F8F2;" id="a311"> </span><span style="color: #66D9EF;" id="a312">openssl_pkey_get_details</span><span style="color: #F8F8F2;" id="a313">($publicKey);</span></div><div class="line" id="a314"><span style="color: #F8F8F2;" id="a315">$verifyResult </span><span style="color: #F92672;" id="a316">=</span><span style="color: #F8F8F2;" id="a317"> </span><span style="color: #66D9EF;" id="a318">openssl_verify</span><span style="color: #F8F8F2;" id="a319">($sigString, </span><span style="color: #66D9EF;" id="a320">base64_decode</span><span style="color: #F8F8F2;" id="a321">($headers[</span><span style="color: #E6DB74;" id="a322">'PAYPAL-TRANSMISSION-SIG'</span><span style="color: #F8F8F2;" id="a323">]), $details[</span><span style="color: #E6DB74;" id="a324">'key'</span><span style="color: #F8F8F2;" id="a325">], </span><span style="color: #E6DB74;" id="a326">'SHA256'</span><span style="color: #F8F8F2;" id="a327">);</span></div><div class="line" id="a328"><span style="color: #F92672;" id="a329">if</span><span style="color: #F8F8F2;" id="a330"> ($verifyResult </span><span style="color: #F92672;" id="a331">===</span><span style="color: #F8F8F2;" id="a332"> </span><span style="color: #AE81FF;" id="a333">1</span><span style="color: #F8F8F2;" id="a334">) {</span></div><div class="line" id="a335"><span style="color: #F8F8F2;" id="a336">    </span><span style="color: #88846F;" id="a337">// 验证成功</span></div><div class="line" id="a338"><span style="color: #F8F8F2;" id="a339">} </span><span style="color: #F92672;" id="a340">else</span><span style="color: #F8F8F2;" id="a341"> {</span></div><div class="line" id="a342"><span style="color: #F8F8F2;" id="a343">    </span><span style="color: #88846F;" id="a344">// 验证失败</span></div><div class="line" id="a345"><span style="color: #F8F8F2;" id="a346">}</span></div></code></pre></div><div class="highlight" id="a347"><pre tabindex="0" style="overflow: hidden;" class="torchlight" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f" onmouseenter="setTimeout(function() { this.style.overflow = 'auto'; }.bind(this), 300)" onmouseleave="this.style.overflow = 'hidden';" ontouchstart="setTimeout(function() { this.style.overflow = 'auto'; }.bind(this), 300)" id="a348"><button data-text="复制" onclick="window.navigator.clipboard.writeText(nextElementSibling.innerText.replace(/&nbsp;/g, ''));this.setAttribute('data-text', '已复制');style='background-color: #009900';setTimeout(() => {this.setAttribute('data-text', '复制');this.removeAttribute('style')}, 1000);" id="a349"></button><code class="language-php" data-lang="php" id="a350"><!-- Syntax highlighted by torchlight.dev --><div class="line" id="a351"><span style="color: #F92672;" id="a352">&lt;?php</span></div><div class="line" id="a353"><span style="color: #F92672;" id="a354">public</span><span style="color: #F8F8F2;" id="a355"> </span><span style="color: #F92672;" id="a356">static</span><span style="color: #F8F8F2;" id="a357"> </span><span style="color: #66D9EF;" id="a358">function</span><span style="color: #F8F8F2;" id="a359"> </span><span style="color: #A6E22E;" id="a360">getAllHeaders</span><span style="color: #F8F8F2;" id="a361">()</span><span style="color: #F92672;" id="a362">:</span><span style="color: #F8F8F2;" id="a363"> </span><span style="color: #F92672;" id="a364">array</span></div><div class="line" id="a365"><span style="color: #F8F8F2;" id="a366">{</span></div><div class="line" id="a367"><span style="color: #F8F8F2;" id="a368">    $headers </span><span style="color: #F92672;" id="a369">=</span><span style="color: #F8F8F2;" id="a370"> [];</span></div><div class="line" id="a371"><span style="color: #F8F8F2;" id="a372">    </span><span style="color: #F92672;" id="a373">foreach</span><span style="color: #F8F8F2;" id="a374"> ($_SERVER </span><span style="color: #F92672;" id="a375">as</span><span style="color: #F8F8F2;" id="a376"> $name </span><span style="color: #F92672;" id="a377">=&gt;</span><span style="color: #F8F8F2;" id="a378"> $value) {</span></div><div class="line" id="a379"><span style="color: #F8F8F2;" id="a380">        </span><span style="color: #F92672;" id="a381">if</span><span style="color: #F8F8F2;" id="a382"> (</span><span style="color: #66D9EF;" id="a383">substr</span><span style="color: #F8F8F2;" id="a384">($name, </span><span style="color: #AE81FF;" id="a385">0</span><span style="color: #F8F8F2;" id="a386">, </span><span style="color: #AE81FF;" id="a387">5</span><span style="color: #F8F8F2;" id="a388">) </span><span style="color: #F92672;" id="a389">==</span><span style="color: #F8F8F2;" id="a390"> </span><span style="color: #E6DB74;" id="a391">'HTTP_'</span><span style="color: #F8F8F2;" id="a392">) {</span></div><div class="line" id="a393"><span style="color: #F8F8F2;" id="a394">            $headers[</span><span style="color: #66D9EF;" id="a395">str_replace</span><span style="color: #F8F8F2;" id="a396">(</span><span style="color: #E6DB74;" id="a397">' '</span><span style="color: #F8F8F2;" id="a398">, </span><span style="color: #E6DB74;" id="a399">'-'</span><span style="color: #F8F8F2;" id="a400">, </span><span style="color: #66D9EF;" id="a401">str_replace</span><span style="color: #F8F8F2;" id="a402">(</span><span style="color: #E6DB74;" id="a403">'_'</span><span style="color: #F8F8F2;" id="a404">, </span><span style="color: #E6DB74;" id="a405">' '</span><span style="color: #F8F8F2;" id="a406">, </span><span style="color: #66D9EF;" id="a407">substr</span><span style="color: #F8F8F2;" id="a408">($name, </span><span style="color: #AE81FF;" id="a409">5</span><span style="color: #F8F8F2;" id="a410">)))] </span><span style="color: #F92672;" id="a411">=</span><span style="color: #F8F8F2;" id="a412"> $value;</span></div><div class="line" id="a413"><span style="color: #F8F8F2;" id="a414">        }</span></div><div class="line" id="a415"><span style="color: #F8F8F2;" id="a416">    }</span></div><div class="line" id="a417"><span style="color: #F8F8F2;" id="a418">    </span><span style="color: #F92672;" id="a419">return</span><span style="color: #F8F8F2;" id="a420"> $headers;</span></div><div class="line" id="a421"><span style="color: #F8F8F2;" id="a422">}</span></div></code></pre></div><div class="highlight" id="a423"><pre tabindex="0" style="overflow: hidden;" class="torchlight" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f" onmouseenter="setTimeout(function() { this.style.overflow = 'auto'; }.bind(this), 300)" onmouseleave="this.style.overflow = 'hidden';" ontouchstart="setTimeout(function() { this.style.overflow = 'auto'; }.bind(this), 300)" id="a424"><button data-text="复制" onclick="window.navigator.clipboard.writeText(nextElementSibling.innerText.replace(/&nbsp;/g, ''));this.setAttribute('data-text', '已复制');style='background-color: #009900';setTimeout(() => {this.setAttribute('data-text', '复制');this.removeAttribute('style')}, 1000);" id="a425"></button><code class="language-php" data-lang="php" id="a426"><!-- Syntax highlighted by torchlight.dev --><div class="line" id="a427"><span style="color: #F92672;" id="a428">&lt;?php</span></div><div class="line" id="a429"><span style="color: #F8F8F2;" id="a430">    </span></div><div class="line" id="a431"><span style="color: #F92672;" id="a432">public</span><span style="color: #F8F8F2;" id="a433"> </span><span style="color: #F92672;" id="a434">static</span><span style="color: #F8F8F2;" id="a435"> </span><span style="color: #66D9EF;" id="a436">function</span><span style="color: #F8F8F2;" id="a437"> </span><span style="color: #A6E22E;" id="a438">httpCurl</span><span style="color: #F8F8F2;" id="a439">($url)</span></div><div class="line" id="a440"><span style="color: #F8F8F2;" id="a441">{</span></div><div class="line" id="a442"><span style="color: #F8F8F2;" id="a443">    $ch </span><span style="color: #F92672;" id="a444">=</span><span style="color: #F8F8F2;" id="a445"> </span><span style="color: #66D9EF;" id="a446">curl_init</span><span style="color: #F8F8F2;" id="a447">();</span></div><div class="line" id="a448"><span style="color: #F8F8F2;" id="a449">    </span><span style="color: #66D9EF;" id="a450">curl_setopt</span><span style="color: #F8F8F2;" id="a451">($ch, </span><span style="color: #AE81FF;" id="a452">CURLOPT_URL</span><span style="color: #F8F8F2;" id="a453">, $url);</span></div><div class="line" id="a454"><span style="color: #F8F8F2;" id="a455">    </span><span style="color: #66D9EF;" id="a456">curl_setopt</span><span style="color: #F8F8F2;" id="a457">($ch, </span><span style="color: #AE81FF;" id="a458">CURLOPT_SSL_VERIFYPEER</span><span style="color: #F8F8F2;" id="a459">, </span><span style="color: #AE81FF;" id="a460">FALSE</span><span style="color: #F8F8F2;" id="a461">);</span></div><div class="line" id="a462"><span style="color: #F8F8F2;" id="a463">    </span><span style="color: #66D9EF;" id="a464">curl_setopt</span><span style="color: #F8F8F2;" id="a465">($ch, </span><span style="color: #AE81FF;" id="a466">CURLOPT_SSL_VERIFYHOST</span><span style="color: #F8F8F2;" id="a467">, </span><span style="color: #AE81FF;" id="a468">FALSE</span><span style="color: #F8F8F2;" id="a469">);</span></div><div class="line" id="a470"><span style="color: #F8F8F2;" id="a471">    </span><span style="color: #66D9EF;" id="a472">curl_setopt</span><span style="color: #F8F8F2;" id="a473">($ch, </span><span style="color: #AE81FF;" id="a474">CURLOPT_RETURNTRANSFER</span><span style="color: #F8F8F2;" id="a475">, </span><span style="color: #AE81FF;" id="a476">1</span><span style="color: #F8F8F2;" id="a477">);</span></div><div class="line" id="a478">&nbsp;</div><div class="line" id="a479"><span style="color: #F8F8F2;" id="a480">    $output </span><span style="color: #F92672;" id="a481">=</span><span style="color: #F8F8F2;" id="a482"> </span><span style="color: #66D9EF;" id="a483">curl_exec</span><span style="color: #F8F8F2;" id="a484">($ch);</span></div><div class="line" id="a485"><span style="color: #F8F8F2;" id="a486">    </span><span style="color: #66D9EF;" id="a487">curl_close</span><span style="color: #F8F8F2;" id="a488">($ch);</span></div><div class="line" id="a489"><span style="color: #F8F8F2;" id="a490">    </span><span style="color: #F92672;" id="a491">return</span><span style="color: #F8F8F2;" id="a492"> $output;</span></div><div class="line" id="a493"><span style="color: #F8F8F2;" id="a494">}</span></div></code></pre></div><h3 class="heading" id="其他说明">其他说明<a class="heading-anchor" href="/play-with-code/paypal-webhook-%E4%BA%8B%E4%BB%B6%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5/#%e5%85%b6%e4%bb%96%e8%af%b4%e6%98%8e" id="a496"></a></h3><ul id="a497"><li id="a498">IPN收款信息中含有：Payment Type,&nbsp;PayPal Payer Address Status,&nbsp;PayPal Payer Status等字段，但是webhook信息中没有这些字段。</li></ul></article><aside id="TocAside" data-nosnippet=""><style>@media(min-width:1201px) and (max-width:1500px){main{margin-left:calc(50% - 600px)!important}}</style><nav id="TableOfContents"><ul><li><a href="#paypal-webhook">PayPal WebHook</a><ul><li><a href="#配置webhook地址和订阅事件">配置WebHook地址和订阅事件</a></li><li><a href="#webhook事件">Webhook事件</a></li></ul></li><li><a href="#接收并验证webhook消息">接收并验证Webhook消息</a><ul><li><a href="#验证方式一调接口获取webhook详情">验证方式一：调接口获取webhook详情</a></li><li><a href="#验证方式二调用验签api">验证方式二：调用验签API</a></li><li><a href="#验证方式三自己手动验证">验证方式三：自己手动验证</a></li><li><a href="#其他说明">其他说明</a></li></ul></li></ul></nav></aside><picture><source srcset="https://storage.roamnote.com:8000/bg.png"><img src="https://storage.roamnote.com:8000/bg.avif" decoding="async" alt="漫游笔记" width="1920" style="aspect-ratio:1920/441"></picture></main></body></html>